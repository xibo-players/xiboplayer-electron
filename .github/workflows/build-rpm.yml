name: Build Electron RPM

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  wait-for-pwa:
    name: Wait for PWA package on npm
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Wait for @xiboplayer/pwa on npm
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LATEST=$(npm view "@xiboplayer/pwa" version 2>/dev/null || echo "0.0.0")
          if [ "$LATEST" = "$VERSION" ]; then
            echo "Already on npm"
            exit 0
          fi
          echo "Waiting for @xiboplayer/pwa@${VERSION} (current: ${LATEST})..."
          for i in $(seq 1 60); do
            if npm view "@xiboplayer/pwa@${VERSION}" version 2>/dev/null; then
              echo "Found on npm after ~$((i * 10))s"
              exit 0
            fi
            sleep 10
          done
          echo "::error::@xiboplayer/pwa@${VERSION} not published after 10 min"
          exit 1

  build:
    needs: [wait-for-pwa]
    if: always() && (needs.wait-for-pwa.result == 'success' || needs.wait-for-pwa.result == 'skipped')
    uses: xibo-players/.github/.github/workflows/build-rpm.yml@main
    with:
      package-name: xiboplayer-electron
      build-command: 'pnpm run build:linux'
      rpm-spec: 'rpm/xiboplayer-electron.spec'
      rpm-script: 'rpm/build-rpm.sh'
      rpm-output-dir: dist-packages
      arch-matrix: '["x86_64", "aarch64"]'
      gpg-sign: true
      publish-to-repo: true
      create-github-release: true
    secrets: inherit
